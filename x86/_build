mkdir -p build
mkdir -p build/kernel
mkdir -p build/kernel/boot
mkdir -p build/kernel/graphics
mkdir -p build/kernel/graphics/gui
mkdir -p build/kernel/input
mkdir -p build/kernel/input/devices
mkdir -p build/kernel/interrupt
mkdir -p build/kernel/io
mkdir -p build/kernel/memory
mkdir -p build/stdlib



echo "Compiling"

#The standard C++11 is important for override in C++.
#TODO: do we need -nostartfiles?
export ARGS_CMPL="-ffreestanding -O2 -Wall -Wextra -fno-exceptions -fno-rtti -std=c++11"
export ARGS_LINK="-ffreestanding -O2 -nostdlib"

echo "  Compiling kernel/boot/*"
nasm -felf      source/kernel/boot/boot.asm -o build/kernel/boot/boot.o
echo "  Compiling kernel/graphics/gui/*"
echo "  Compiling kernel/graphics/*"
i586-elf-g++ -c source/kernel/graphics/vesa.cpp -o build/kernel/graphics/vesa.o $ARGS_CMPL
echo "  Compiling kernel/input/devices/*"
i586-elf-g++ -c source/kernel/input/devices/controller_ps2.cpp -o build/kernel/input/devices/controller_ps2.o $ARGS_CMPL
i586-elf-g++ -c source/kernel/input/devices/device.cpp -o build/kernel/input/devices/device.o $ARGS_CMPL
i586-elf-g++ -c source/kernel/input/devices/keyboard.cpp -o build/kernel/input/devices/keyboard.o $ARGS_CMPL
i586-elf-g++ -c source/kernel/input/devices/mouse.cpp -o build/kernel/input/devices/mouse.o $ARGS_CMPL
echo "  Compiling kernel/input/*"
i586-elf-g++ -c source/kernel/input/keys.cpp -o build/kernel/input/keys.o $ARGS_CMPL
echo "  Compiling kernel/interrupt/*"
echo "  Compiling kernel/interrupt/<idt>"
nasm -felf      source/kernel/interrupt/idt.asm -o build/kernel/interrupt/idt1.o
i586-elf-g++ -c source/kernel/interrupt/idt.cpp -o build/kernel/interrupt/idt2.o $ARGS_CMPL
echo "  Compiling kernel/interrupt/<int32>"
nasm -felf      source/kernel/interrupt/int32.asm -o build/kernel/interrupt/int32.o
echo "  Compiling kernel/interrupt/<isr>"
nasm -felf      source/kernel/interrupt/isr.asm -o build/kernel/interrupt/isr1.o
i586-elf-g++ -c source/kernel/interrupt/isr.cpp -o build/kernel/interrupt/isr2.o $ARGS_CMPL
echo "  Compiling kernel/interrupt/<pic>"
i586-elf-g++ -c source/kernel/interrupt/pic.cpp -o build/kernel/interrupt/pic.o $ARGS_CMPL
echo "  Compiling kernel/io/*"
i586-elf-g++ -c source/kernel/io/io.cpp -o build/kernel/io/io.o $ARGS_CMPL
echo "  Compiling kernel/memory/*"
nasm -felf      source/kernel/memory/gdt.asm    -o build/kernel/memory/gdt1.o
i586-elf-g++ -c source/kernel/memory/gdt.cpp    -o build/kernel/memory/gdt2.o $ARGS_CMPL
i586-elf-g++ -c source/kernel/memory/simple.cpp -o build/kernel/memory/simple.o $ARGS_CMPL
echo "  Compiling kernel/*"
i586-elf-g++ -c source/kernel/kernel.cpp             -o build/kernel/kernel.o $ARGS_CMPL
i586-elf-g++ -c source/kernel/setup.cpp              -o build/kernel/setup.o $ARGS_CMPL
i586-elf-g++ -c source/kernel/text_mode_terminal.cpp -o build/kernel/text_mode_terminal.o $ARGS_CMPL
echo "  Compiling stdlib/*"
i586-elf-g++ -c source/stdlib/stdlib.cpp -o build/stdlib/stdlib.o $ARGS_CMPL
echo "  Compiling *"
i586-elf-g++ -c source/includes.cpp -o build/includes.o $ARGS_CMPL



echo "Linking kernel"

i586-elf-gcc\
	-T source/linker.ld\
	-o build/MOSS.bin\
	$ARGS_LINK\
\
\
	build/kernel/boot/boot.o\
	build/kernel/graphics/vesa.o\
	build/kernel/input/devices/controller_ps2.o\
	build/kernel/input/devices/device.o\
	build/kernel/input/devices/keyboard.o\
	build/kernel/input/devices/mouse.o\
	build/kernel/input/keys.o\
	build/kernel/interrupt/idt1.o\
	build/kernel/interrupt/idt2.o\
	build/kernel/interrupt/int32.o\
	build/kernel/interrupt/isr1.o\
	build/kernel/interrupt/isr2.o\
	build/kernel/interrupt/pic.o\
	build/kernel/io/io.o\
	build/kernel/memory/gdt1.o\
	build/kernel/memory/gdt2.o\
	build/kernel/memory/simple.o\
\
	build/kernel/kernel.o\
	build/kernel/setup.o\
	build/kernel/text_mode_terminal.o\
\
	build/stdlib/stdlib.o\
\
	build/includes.o\
\
\
	-lgcc
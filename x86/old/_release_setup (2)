#Sets up a common disk image that is used for building the VM disk or
#installing to USB

#See: http://wiki.osdev.org/Loopback_Device
#See: http://superuser.com/questions/130955/how-to-install-grub-into-an-img-file

export CYLINDERS=100
export HEADS=16
export SECTORS_PER_TRACK=63
export SECTOR_SIZE=512

#Make HDD image
dd if=/dev/zero of=build/moss-disk.bin bs=$((HEADS*SECTORS_PER_TRACK*SECTOR_SIZE)) count=$CYLINDERS

#Make partition on disk file (re-enable as necessary)
cat <<EOF | fdisk -u -C$((CYLINDERS)) -S$((SECTORS_PER_TRACK)) -H$((HEADS)) build/moss-disk.bin
o
n
p



a
1
p
w
EOF

sudo partprobe /dev/loop0

#Mount the disk image in a loop device
#	Note: the number is the start field of the about partition * SECTOR_SIZE bytes/sector
#	See the previous fdisk command, which should have printed it (prints as 2048, instead of 63)
sudo losetup -o$((2048*SECTOR_SIZE)) /dev/loop0 build/moss-disk.bin

#Make a file system on it (re-enable as necessary)
#	Note: the 4016 is the number of blocks (see fdisk command above, which should have printed it.
#	Note: source also explains how to set up FAT32
sudo mke2fs /dev/loop0

#Note: may have to unmount loop, restart, and then remount loop here.  See http://forum.osdev.org/viewtopic.php?f=1&t=26907

#Mount partition
sudo mount -t ext2 /dev/loop0 /mnt



sudo mkdir -p /mnt/boot
sudo mkdir -p /mnt/boot/grub

#http://wiki.centos.org/HowTos/GrubInstallation
#Install to MBR, not first partition
sudo losetup /dev/loop1 build/moss-disk.bin
sudo grub-install --root-directory=/mnt /dev/loop1
sudo losetup -d /dev/loop1

sudo cp build/MOSS.bin /mnt/boot/MOSS.bin
sudo cp source/menu.lst /mnt/boot/grub/menu.lst




#Unmount partition
sudo umount /mnt

#Unmount the disk image from the loop device
sudo losetup -d /dev/loop0


















#define NULL 0

#define MEM_VGA ((unsigned char*)(0x000A0000))
#define bool char

int locs[6][2] = {{10,10},{5,5},{15,15},{10,15},{15,10},{100,10}};

//Custom made byte-font
static const char font[128][5] = {{0x31,0x25,0x0,0x42,0xe},{0x40,0x0,0x0,0x5,0x35},{0x20,0x0,0x0,0x5,0x35},{0x60,0x0,0x0,0x5,0x35},{0x10,0x0,0x0,0x5,0x35},{0x50,0x0,0x0,0x5,0x35},{0x51,0x4,0x6,0x10,0x23},{0x33,0x1c,0x33,0x46,0x2c},{0x0,0x44,0x3e,0x41,0x0},{0x0,0x41,0x3e,0x11,0x0},{0x0,0x42,0x2a,0x71,0x0},{0x29,0x22,0x0,0x71,0x4},{0x18,0x0,0x0,0x5,0x35},{0x62,0xc,0xc,0x29,0x45},{0x38,0x0,0x0,0x5,0x35},{0x78,0x0,0x0,0x5,0x35},{0x4,0x0,0x0,0x5,0x35},{0x44,0x0,0x0,0x5,0x35},{0x24,0x0,0x0,0x5,0x35},{0x64,0x0,0x0,0x5,0x35},{0x14,0x0,0x0,0x5,0x35},{0x66,0x59,0x5d,0xc,0x2e},{0x34,0x0,0x0,0x5,0x35},{0x74,0x0,0x0,0x5,0x35},{0xc,0x0,0x0,0x5,0x35},{0x4c,0x0,0x0,0x5,0x35},{0x2c,0x0,0x0,0x5,0x35},{0x3,0x39,0x35,0x16,0x60},{0x1c,0x0,0x0,0x5,0x35},{0x5c,0x0,0x0,0x5,0x35},{0x3c,0x0,0x0,0x5,0x35},{0x7c,0x0,0x0,0x5,0x35},{0x0,0x0,0x0,0x0,0x0},{0x0,0x42,0x8,0x1,0x0},{0x29,0x20,0x0,0x0,0x0},{0x1,0x2f,0x55,0x7a,0x40},{0x11,0x6a,0x1c,0x2b,0x44},{0x67,0x21,0x8,0x42,0x73},{0x19,0x16,0x2b,0x14,0x6d},{0x10,0x40,0x0,0x0,0x0},{0x8,0x44,0x10,0x41,0x2},{0x20,0x41,0x4,0x11,0x8},{0x0,0x5,0x8,0x50,0x0},{0x0,0x42,0x3e,0x21,0x0},{0x0,0x0,0x0,0x1,0x8},{0x0,0x0,0x3e,0x0,0x0},{0x0,0x0,0x0,0x1,0x0},{0x8,0x22,0x8,0x22,0x8},{0x1,0x65,0x14,0x53,0x40},{0x0,0x46,0x8,0x23,0x40},{0x0,0x45,0x4,0x23,0x40},{0x1,0x41,0x18,0x13,0x0},{0x0,0x25,0x1c,0x10,0x40},{0x1,0x64,0x8,0x13,0x0},{0x0,0x64,0x1c,0x53,0x40},{0x1,0x61,0x4,0x21,0x0},{0x0,0x45,0x8,0x51,0x0},{0x0,0x45,0xc,0x11,0x0},{0x0,0x2,0x0,0x20,0x0},{0x0,0x2,0x0,0x22,0x0},{0x0,0x22,0x10,0x20,0x40},{0x0,0x7,0x0,0x70,0x0},{0x1,0x2,0x4,0x22,0x0},{0x1,0x41,0x8,0x1,0x0},{0x19,0x19,0x6b,0x2d,0x6c},{0x0,0x45,0x1c,0x52,0x40},{0x1,0x45,0x18,0x53,0x0},{0x0,0x64,0x10,0x41,0x40},{0x1,0x45,0x14,0x53,0x0},{0x1,0x64,0x18,0x43,0x40},{0x1,0x64,0x18,0x42,0x0},{0x0,0x44,0x14,0x51,0x40},{0x1,0x25,0x1c,0x52,0x40},{0x1,0x62,0x8,0x23,0x40},{0x1,0x61,0x4,0x51,0x0},{0x1,0x25,0x18,0x52,0x40},{0x1,0x4,0x10,0x43,0x40},{0x1,0x2a,0x6b,0x2c,0x20},{0x2,0x1c,0x6b,0x1c,0x20},{0x1,0x68,0x63,0xb,0x40},{0x1,0x45,0x18,0x42,0x0},{0x1,0x68,0x63,0xb,0x41},{0x1,0x65,0x18,0x52,0x20},{0x0,0x64,0x8,0x13,0x0},{0x1,0x62,0x8,0x21,0x0},{0x1,0x25,0x14,0x51,0x40},{0x1,0x25,0x14,0x51,0x0},{0x2,0x1a,0x6b,0x2a,0x40},{0x1,0x25,0x8,0x52,0x40},{0x1,0x25,0x8,0x21,0x0},{0x1,0x61,0x8,0x43,0x40},{0x39,0x4,0x10,0x42,0xe},{0x21,0x2,0x8,0x20,0x42},{0x38,0x21,0x4,0x10,0x4e},{0x11,0x28,0x40,0x0,0x0},{0x0,0x0,0x0,0x0,0x1f},{0x20,0x40,0x0,0x0,0x0},{0x0,0x3,0x14,0x53,0x40},{0x1,0x4,0x1c,0x53,0x0},{0x0,0x0,0x8,0x43,0x0},{0x0,0x21,0xc,0x53,0x40},{0x0,0x7,0x1c,0x43,0x40},{0x0,0x44,0x18,0x42,0x0},{0x0,0x3,0x14,0x70,0x4c},{0x1,0x4,0x18,0x52,0x40},{0x0,0x2,0x0,0x21,0x0},{0x0,0x2,0x0,0x21,0x8},{0x1,0x5,0x18,0x62,0x40},{0x1,0x42,0x8,0x21,0x0},{0x0,0x0,0x15,0x2c,0x20},{0x0,0x0,0x18,0x52,0x40},{0x0,0x0,0x8,0x51,0x0},{0x0,0x6,0x14,0x62,0x8},{0x0,0x3,0x14,0x70,0x43},{0x0,0x2,0x14,0x42,0x0},{0x0,0x3,0x10,0x33,0x40},{0x0,0x2,0x1c,0x21,0x2},{0x0,0x0,0x14,0x53,0x40},{0x0,0x0,0x14,0x51,0x0},{0x0,0x0,0x23,0x2a,0x40},{0x0,0x0,0x14,0x22,0x40},{0x0,0x0,0x14,0x70,0x4e},{0x0,0x7,0x4,0x63,0x40},{0x18,0x42,0x10,0x21,0x6},{0x10,0x42,0x8,0x21,0x4},{0x30,0x42,0x4,0x21,0xc},{0x0,0x4,0x6b,0x10,0x0},{0x62,0x4c,0x0,0x21,0x6}};

//Text mode stuff
#if 0
#define MEM_TEXT ((unsigned short*)(0x00B8000))
//static unsigned char* video = (unsigned char*)(0x00B8000);

//0x0 => (  0,  0,  0) => black                0x0 => (  0,  0,  0) => black
//0x1 => (  0,  0,168) => dark blue            0x8 => ( 87, 87, 87) => dark grey
//0x2 => (  0,168,  0) => dark green           0x7 => (168,168,168) => light grey
//0x3 => (  0,168,168) => dark cyan            0xF => (255,255,255) => white
//0x4 => (168,  0,  0) => dark red
//0x5 => (168,  0,168) => dark magenta         0x4 => (168,  0,  0) => dark red
//0x6 => (168, 87,  0) => dark orange/brown    0xC => (255, 87, 87) => light red
//0x7 => (168,168,168) => light grey
//0x8 => ( 87, 87, 87) => dark grey            0x6 => (168, 87,  0) => dark orange/brown
//0x9 => ( 87, 87,255) => light blue
//0xA => ( 87,255, 87) => light green          0xE => (255,255, 87) => light yellow
//0xB => ( 87,255,255) => light cyan
//0xC => (255, 87, 87) => light red            0x2 => (  0,168,  0) => dark green
//0xD => (255, 87,255) => light magenta        0xA => ( 87,255, 87) => light green
//0xE => (255,255, 87) => light yellow
//0xF => (255,255,255) => white                0x1 => (  0,  0,168) => dark blue
//                                             0x9 => ( 87, 87,255) => light blue

//                                             0x3 => (  0,168,168) => dark cyan
//                                             0xB => ( 87,255,255) => light cyan

//                                             0x5 => (168,  0,168) => dark magenta
//                                             0xD => (255, 87,255) => light magenta

char color(char foreground, char background) {
	return ((short)(background)<<4) | ((short)(foreground));
}
void write_char(int x, int y, char character, char foreground, char background) {
	MEM_TEXT[y*80+x] = ((short)(color(foreground,background))<<8) | ((short)(character));
}
void write_str(int x, int y, const char* str, char foreground, char background) {
	/*char c;
	LOOP:
		c = *str;
		if (c=='\0') return;
		write_char(video,x++,y,'H',foreground,background);
		++str;
		goto LOOP;*/
	write_char(x++,y,str[3],foreground,background);
}
void clear(char character, char foreground, char background) {
	int x,y;
	for (y=0;y<25;++y) {
		for (x=0;x<80;++x) {
			write_char(x,y,character,foreground,background);
		}
	}
}
#endif

void plot_pixel(int x, int y, char color);

void draw_character(int x, int y, unsigned char which);
void draw_string(int x, int y, const char* str);

void kernel_main(void) {
	//int locs[6][2] = {{10,10},{5,5},{15,15},{10,15},{15,10},{100,10}};

	//const char* str = "Welcome to MOSS!";
	//write_str(video,0,0,str,0x8,0x1);

	/*int i = 0;
	do {
		plot_pixel(locs[i][0],locs[i][1],0x30);
	} while (++i<6);*/

	/*draw_character( 0,0,'W');
	draw_character( 1,0,'e');
	draw_character( 2,0,'l');
	draw_character( 3,0,'c');
	draw_character( 4,0,'o');
	draw_character( 5,0,'m');
	draw_character( 6,0,'e');
	draw_character( 7,0,' ');
	draw_character( 8,0,'t');
	draw_character( 9,0,'o');
	draw_character(10,0,' ');
	draw_character(11,0,'M');
	draw_character(12,0,'O');
	draw_character(13,0,'S');
	draw_character(14,0,'S');
	draw_character(15,0,'!');*/
	draw_string(0,0,"Welcome to MOSS!");

	/*plot_pixel(10,10,0x30);
	plot_pixel(5,5,0x30);
	plot_pixel(15,15,0x30);
	plot_pixel(10,15,0x30);
	plot_pixel(15,10,0x30);
	plot_pixel(100,10,0x30);*/

	HANG: goto HANG;
}
void plot_pixel(int x, int y, char color) {
	unsigned short offset = x + 320 * y;
	MEM_VGA[offset] = color;
}

void draw_character(int x, int y, unsigned char which) {
	const char* c = font[which];

	bool bits[35] = {0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0};

	int i = 0, j;
	int b = 0;
	do {
		char byte = c[b];
		j = 0;
		do {
			bits[i++] = (byte & (0x1<<(7-j-1)))  !=  0x0;
		} while (++j<7);
	} while (++b<5);

	//bool bits[35] = {1,0,0,0,1, 0,1,0,1,0, 0,1,0,1,0, 0,1,1,1,0, 0,1,0,1,0, 0,1,1,1,0, 1,0,0,0,1};

	x *= 5;
	y *= 7;

	int x2,y2;
	for (y2=0;y2<7;++y2) {
		for (x2=0;x2<5;++x2) {
			if (bits[y2*5+x2]) {
				plot_pixel(x+x2,y+y2,0x30);
			}
		}
	}
}
void draw_string(int x, int y, const char* str) {
	char c;
	LOOP:
		c = *str;
		if (c=='\0') return;
		else if (c=='\r') x = 0;
		else if (c=='\n') ++y;
		else draw_character(x++,y,c);
		++str;
		goto LOOP;
}
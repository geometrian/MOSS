/*
Print `double`-precision value into string `buf`.  This is surprisingly difficult.  Uses the
apparent current state of the art, Ryū:

	https://dl.acm.org/doi/10.1145/3192366.3192369
	https://github.com/ulfjack/ryu/blob/77e767f5e056bab96e895072fc21618ecff2f44b/src/main/java/info/adams/ryu/RyuDouble.java

See also:

	http://www.cs.indiana.edu/~dyb/pubs/FP-Printing-PLDI96.pdf
	Grisu https://bit.ly/2JgMggX
	Approximate:
		http://0x80.pl/notesen/2015-12-29-float-to-string.html
		https://github.com/charlesnicholson/nanoprintf/blob/main/nanoprintf.h
*/



#include "assert.h"
#include "math.h"

#include <stdint.h>
#include "stdio.h"



/*
POW5_NBITS         = 121
POW5_NBITS_QUARTER =  31
POW5_INV_NBITS         = 122
POW5_INV_NBITS_QUARTER =  31

POS_TABLE_SIZE = 326
NEG_TABLE_SIZE = 291
POW5     = [ 0 for i in range(POS_TABLE_SIZE) ]
POW5_INV = [ 0 for i in range(NEG_TABLE_SIZE) ]
POW5_SPLIT     = [ [0,0,0,0] for i in range(POS_TABLE_SIZE) ]
POW5_INV_SPLIT = [ [0,0,0,0] for i in range(NEG_TABLE_SIZE) ]

mask     = ( 1 << POW5_NBITS_QUARTER     ) - 1
mask_inv = ( 1 << POW5_INV_NBITS_QUARTER ) - 1

#See comment in C file
def exp5_nbits( exp ):
	return ( exp*1217359 >> 19 ) + 1

def shift_right( val, amt ):
	if amt >= 0: return val >>  amt
	else       : return val << -amt

for i in range(max( len(POW5), len(POW5_INV) )):
	power = 5 ** i

	nbits = len(bin(power)) - 2
	assert exp5_nbits(i) == nbits

	if i < len(POW5):
		POW5[i] = power

	if i < len(POW5_SPLIT):
		for k in range(4):
			shift = nbits - POW5_NBITS + (3-k)*POW5_NBITS_QUARTER
			POW5_SPLIT[i][k] = shift_right( power, shift ) & mask

	if i < len(POW5_INV_SPLIT):
		#We want ⌊log₂(5^q)⌋ here, which is `nbits` - 1.
		j = nbits-1 + POW5_INV_NBITS
		inv = (1<<j)//power + 1
		POW5_INV[i] = inv
		for k in range(4):
			inv >>= (3-k) * POW5_INV_NBITS_QUARTER
			if k == 0:
				POW5_INV_SPLIT[i][k] = inv
			else:
				POW5_INV_SPLIT[i][k] = inv & mask_inv

s = ""

def print_arr( arr ):
	global s
	line_len = 100
	for a,b,c,d in arr:
		fmtted = f"{{{a},{b},{c},{d}}},"
		if line_len+1+len(fmtted) > 100:
			s += "\n\t" + fmtted
			line_len = 4 + len(fmtted)
		else:
			s += " " + fmtted
			line_len += 1 + len(fmtted)

s += f"static int32_t const POW5_SPLIT    [{len(POW5_SPLIT    )}][4] =\n{{"
print_arr( POW5_SPLIT )
s = s[:-1] + "\n};\n"

s += f"static int32_t const POW5_INV_SPLIT[{len(POW5_INV_SPLIT)}][4] =\n{{"
print_arr( POW5_INV_SPLIT )
s = s[:-1] + "\n};\n"

print(s)
*/

/* TODO: `POW5_INV_SPLIT` looks like it can store 1/4 the data */

#define POW5_NBITS     121
#define POW5_INV_NBITS 122

static int32_t const POW5_SPLIT    [326][4] =
{
	{134217728,0,0,0}, {167772160,0,0,0}, {209715200,0,0,0}, {262144000,0,0,0}, {163840000,0,0,0},
	{204800000,0,0,0}, {256000000,0,0,0}, {160000000,0,0,0}, {200000000,0,0,0}, {250000000,0,0,0},
	{156250000,0,0,0}, {195312500,0,0,0}, {244140625,0,0,0}, {152587890,1342177280,0,0},
	{190734863,603979776,0,0}, {238418579,218103808,0,0}, {149011611,2015363072,0,0},
	{186264514,1982332928,0,0}, {232830643,1404174336,0,0}, {145519152,609173504,0,0},
	{181898940,761466880,0,0}, {227373675,951833600,0,0}, {142108547,326460544,0,0},
	{177635683,2018688416,0,0}, {222044604,1986489608,0,0}, {138777878,167814181,0,0},
	{173472347,1283509550,536870912,0}, {216840434,1067516025,1744830464,0},
	{135525271,1204068428,285212672,0}, {169406589,968214623,356515840,0},
	{211758236,1747139190,2056257536,0}, {264697796,36440340,1496580096,0},
	{165436122,1096517036,2009104384,0}, {206795153,296904472,363896832,0},
	{258493941,908001502,454871040,0}, {161558713,835936394,1894907136,0},
	{201948391,1581791405,1294892096,0}, {252435489,1440368345,8002384,0},
	{157772181,94923847,1347178770,0}, {197215226,655525721,1147102550,1073741824},
	{246519032,1893148975,1970749100,268435456}, {154074395,1183218109,2037024555,1241513984},
	{192592994,942151725,935667958,1015021568}, {240741243,103947832,1706455860,195035136},
	{150463276,1944015587,1066534912,1195638784}, {188079096,282535836,796297728,1494548480},
	{235098870,353169795,995372160,1868185600}, {146936793,1831343858,353672144,1167616000},
	{183670992,678567086,1515832004,1459520000}, {229588740,848208858,821048181,1824400000},
	{143492962,1603872360,1050026025,1408685456}, {179366203,931098626,1312532532,150244084},
	{224207754,627002371,566923841,187805105}, {140129846,928747394,85891944,1459555470},
	{175162308,87192418,1181106754,1824444338}, {218952885,108990523,402641619,1206813598},
	{136845553,336554532,2130699204,485823043}, {171056941,957564078,515890357,607278804},
	{213821176,1733826009,1718604770,1295969417}, {267276471,19798864,537643227,546219947},
	{167047794,817680658,336027017,72952011}, {208809742,2095842646,1493775595,628060925},
	{261012178,1546061484,793477670,248205245}, {163132611,1503159339,1569665367,1765741014},
	{203915764,1342078262,1425210797,1670305355}, {254894705,1677597828,707771673,477268958},
	{159309191,243192274,1516099119,1640470379}, {199136488,1914603079,821382075,1513717062},
	{248920611,245770201,489856682,1355275415}, {155575381,2032654567,1648337706,1383918046},
	{194469227,930205473,1523551221,656155734}, {243086534,625885930,293826290,1357065580},
	{151929083,2001791442,720512343,1385036899}, {189911354,1965368390,1974382253,1194425212},
	{237389193,1382968664,1394235992,2029902427}, {148368246,59049047,871397495,1268689017},
	{185460307,1147553133,552375957,1048990359}, {231825384,897570504,1227340858,1848108861},
	{144890865,560981565,767088036,1691938950}, {181113581,1238097868,1495730957,2114923688},
	{226391976,2084493247,1869663697,1033041874}, {141494985,1302808279,1973846178,1987828451},
	{176868732,17897613,1930436811,1411043740}, {221085915,22372017,802433278,1226933763},
	{138178696,1893030702,1843698079,229962689}, {172723371,218804730,1230880774,1898066098},
	{215904213,1884118649,464859144,1298840799}, {134940133,1446009611,1632714245,811775499},
	{168675167,196899278,1504021894,1551590286}, {210843958,1856736834,806285544,865746033},
	{263554948,1247179218,2081598754,1082182542}, {164721842,1853228835,1837870133,1213235000},
	{205902303,1242794220,1760466754,2053414663}, {257377879,1016621864,53099795,1493026504},
	{160861174,1440695033,33187372,664706109}, {201076468,727126967,578355127,830882636},
	{251345585,908908709,186072997,501732384}, {157090990,1910245223,384731079,582018196},
	{196363738,1314064704,2091526585,190651833}, {245454673,568839057,466924583,775185703},
	{153409170,1697701690,1634005144,1289797432}, {191761463,1048385289,968764606,1612246790},
	{239701829,773610699,1747826670,941566664}, {149813643,751942143,823956213,51608253},
	{187267054,403056767,493074354,601381228}, {234083817,1577562783,79472030,1825468359},
	{146302386,180670371,854976387,604046812}, {182877982,1299579788,531849572,218187604},
	{228597478,550732911,664811965,272734505}, {142873423,1954820805,1220813846,438894521},
	{178591779,1906655094,2062888219,1622359976}, {223239724,1846447956,1504868450,1491079058},
	{139524828,80288148,2014284605,1468795323}, {174406035,100360186,370372109,225381418},
	{218007543,1736062968,1536706960,818597684}, {136254714,1890345723,960441850,511623552},
	{170318393,1289190330,663681400,1713271265}, {212897992,875176,1903343574,2141589081},
	{266122490,1093971,231695820,1603244527}, {166326556,537554643,2023858079,2075769653},
	{207908195,671943304,1992951687,2057841155}, {259885244,303058219,343705961,2035430532},
	{162428277,1263153210,2093864418,466837714}, {203035346,2115812425,1543588698,1657288967},
	{253794183,1571023708,318873137,997869385}, {158621364,1787196185,1273037534,1965845645},
	{198276706,86511583,2128167830,1383565233}, {247845882,1181881303,2123338876,655714717},
	{154903676,1275546726,2132393165,1483563522}, {193629595,1594433408,1591749633,243841667},
	{242036994,1456170848,1989687041,841672995}, {151273121,1446977692,1243554400,1868222902},
	{189091402,198109379,1554443001,187794979}, {236364252,1321378548,1406182839,771614636},
	{147727657,1899603416,1952606098,1287565516}, {184659572,763891535,293273975,535715071},
	{230824465,954864418,1977205205,132772926}, {144265290,1938967541,1772624165,351418535},
	{180331613,1349967603,605167470,976144081}, {225414517,76846768,219588426,146438277},
	{140884073,316464686,137242766,628394835}, {176105091,932451769,1245295281,1859235368},
	{220131364,628693799,2093490014,713431474}, {137582102,1466675448,2113737626,2056507407},
	{171977628,759602487,494688385,1496892435}, {214972035,949503109,81489570,260502808},
	{134357522,325003987,319366437,699685167}, {167946902,1479996807,2009820782,1411477370},
	{209933628,776254185,1975405066,690604889}, {262417035,970317732,858643596,1936997935},
	{164010647,338013126,1610394072,136881885}, {205013308,2033129144,939250766,171102357},
	{256266636,393927782,1174063457,1287619770}, {160166647,1319946688,196918748,2146939636},
	{200208309,1113062448,246148436,536190897}, {250260386,1928198972,307685545,670238622},
	{156412741,1741995269,1266045289,1761076419}, {195515927,566881350,2119427524,590732787},
	{244394909,171730776,1575542581,738415984}, {152746818,375767191,984714113,729945446},
	{190933522,1543450813,694021729,1449302720}, {238666903,855571692,1404398074,201015664},
	{149166814,1340038675,1951490620,662505702}, {186458518,601306520,1902492363,828132127},
	{233073147,1825374975,230631806,498294247}, {145670717,872423903,949451246,1922046640},
	{182088396,1627400791,649943146,1328816476}, {227610495,2034250989,275558021,587278772},
	{142256559,2076713236,440659219,635484688}, {177820699,2059020633,550824024,257484948},
	{222275874,2036904879,1225400942,321856185}, {138922421,1809936461,1571181956,1811772852},
	{173653027,651807841,353364710,117232417}, {217066284,277888889,978576799,1220282345},
	{135666427,1247422379,1953787779,1567982833}, {169583034,1022407062,1905363812,1423107630},
	{211978793,204267004,1307962941,1778884537}, {264973491,792204667,1634953677,612992936},
	{165608432,226692461,753410592,651556041}, {207010540,283365576,1478634152,814445051},
	{258763175,354206970,1848292690,1018056314}, {161726984,1026685724,1692053843,1173156108},
	{202158730,1283357155,2115067304,929574223}, {252698413,530454620,2106963218,1161967779},
	{157936508,599969594,243110187,1263100774}, {197420635,749961992,1377629558,1042005055},
	{246775794,400581578,1722036948,228764495}, {154234871,787234398,1613144004,1216719633},
	{192793589,447172086,942688181,1520899542}, {240991986,1095836020,104618403,290511691},
	{150619991,1221768424,1139128325,2060617999}, {188274989,990339618,1423910407,965159763},
	{235343736,1774795435,706146185,669578792}, {147089835,1109247147,172905909,1760664025},
	{183862294,849688021,1826745123,590217295}, {229827867,2135851851,672818668,200900707},
	{143642417,1066471951,152076211,1199304766}, {179553021,1869960850,1800708000,962260045},
	{224441277,726838327,1177143176,1202825056}, {140275798,722709410,1541020853,751765660},
	{175344747,1977128587,852534242,1476577987}, {219180934,1934539822,528796891,771980660},
	{136988084,672216476,1941110793,214052456}, {171235105,840270596,278904843,804436483},
	{214043881,1587209157,348631054,468674691}, {267554852,373398710,972659729,1659585188},
	{167221782,1307116018,71041419,231934375}, {209027228,560153198,1162543597,1900530704},
	{261284035,700191498,379437673,765050645}, {163302522,169184230,774019457,1820333933},
	{204128152,1285222111,2041266146,664804680}, {255160190,1606527639,2014711770,1904747674},
	{159475119,467208862,2064501224,1727338208}, {199343899,47140166,1506884707,11689112},
	{249179873,1669537944,809864059,1625224126}, {155737421,238154847,506165037,747329623},
	{194671776,834564471,95835384,1471032941}, {243339720,1043205588,1730406966,1838791176},
	{152087325,652003493,7762530,612373573}, {190109156,1351875278,546574074,1839208790},
	{237636445,1689844097,1756959417,1225269164}, {148522778,1324588017,292793267,2107970507},
	{185653473,581993197,902862496,2098092222}, {232066841,1264362408,1665449033,475131630},
	{145041775,2132403785,1040905645,1639134548}, {181302219,2128633819,1838002969,438305450},
	{226627774,2123921362,1760632799,1084752724}, {141642359,790579939,1637266411,1483276820},
	{177052949,451354012,1509712102,1317225114}, {221316186,1101063427,1887140128,572789568},
	{138322616,1225035554,911027124,357993480}, {172903270,1531294443,65042081,447491850},
	{216129088,840376229,1691915337,1096235725}, {135080680,525235143,1325882541,2027324608},
	{168850850,656543929,1120482265,923543024}, {211063562,1894421735,1937473743,1691299692},
	{263829453,1294285345,1884971267,1577253703}, {164893408,1077363797,372800674,717348108},
	{206116760,1346704746,1002871754,1970426959}, {257645950,1683380933,179847869,1389291875},
	{161028719,515242171,380840374,1136742878}, {201285899,107181801,2086663204,347186773},
	{251607373,1744589988,997716269,433983467}, {157254608,1358804198,1697314492,539675123},
	{196568260,1698505248,1047901291,674593903}, {245710325,2123131560,1309876614,306371467},
	{153568953,1595392681,818672883,1802094903}, {191961192,383628115,1560212016,1715747717},
	{239951490,479535144,1413394108,2144684646}, {149969681,836580377,883371318,266686080},
	{187462101,1582596383,1641085059,1407099424}, {234327627,367632743,1514485412,1222003368},
	{146454766,2108818656,1751859750,1837493929}, {183068458,1562281497,42341040,1223125587},
	{228835573,879110047,589797212,1528906984}, {143022233,817879235,1173929625,2029308689},
	{178777791,1559219956,930541120,926023125}, {223472239,1412154033,1163176400,1157528906},
	{139670149,1687902638,2069162530,723455566}, {174587687,499265562,1512711338,1978061282},
	{218234609,87211041,817147349,1398834779}, {136396630,1396684180,1852894373,1142707192},
	{170495788,672113402,168634318,1965254903}, {213119735,840141752,1284534722,1382826804},
	{266399669,513306278,1605668403,654791682}, {166499793,589251880,466671840,140809345},
	{208124741,1273435762,583339800,176011681}, {260155926,2128665614,1802916574,220014602},
	{162597454,793545097,589951946,1748121862}, {203246817,2065673195,1274310845,1111410503},
	{254058522,971478758,1056017644,1926134041}, {158786576,1144045136,123140116,130091952},
	{198483220,1430056420,153925145,162614940}, {248104025,1787570525,192406431,740139587},
	{155065016,311925210,388689475,1267893610}, {193831270,389906512,1559603668,1047996100},
	{242289087,1561124964,1949504585,1309995125}, {151430679,1781009471,144698542,13440585},
	{189288349,1689390926,1791485913,1090542555}, {236610437,501125922,1165615567,1900049106},
	{147881523,581639157,1265380641,1992837059}, {184851904,190178034,2118596714,880433588},
	{231064880,237722543,1574504069,26800161}, {144415550,148576589,1789371411,285185557},
	{180519437,1259462561,626101527,1967094682}, {225649296,2111199113,1319497821,1921997441},
	{141030810,1319499446,19379770,1469683856}, {176288513,575632483,1097966537,763362996},
	{220360641,1256411516,835587259,1491074658}, {137725400,2127434477,1595983861,663486205},
	{172156751,511809449,384367090,1366228668}, {215195939,102890899,1017329775,634044011},
	{134497461,1943355004,367395653,1201583875}, {168121827,818581019,459244566,2038850756},
	{210152284,486355362,37184796,1474821621}, {262690355,607944202,1120222819,1843527026},
	{164181472,111529670,1237010174,883768935}, {205226840,139412088,472520894,30969345},
	{256533550,174265110,590651117,1112453505}, {160333468,1719528429,1979769684,963718897},
	{200416836,1926889,864099369,1204648621}, {250521045,2408611,1616995123,2042681688},
	{156575653,269940838,742186496,1008240599}, {195719566,874296959,2001474944,1260300749},
	{244649458,19129375,1964972768,1575375936}, {152905911,548826771,2033414348,984609960},
	{191132389,149162552,2004897023,1230762450}, {238915486,723324103,358637631,1001582151},
	{149322178,2062690300,1029454887,1431295212}, {186652723,1504621051,1286818609,1252248103},
	{233315904,1343905402,1071652349,2102181041}, {145822440,839940876,1206653630,1582298607},
	{182278050,1049926095,1508317038,904131434}, {227847563,238665795,1348525386,56422469},
	{142404726,2028214314,574392910,572134955}, {178005908,1461526068,1791732961,1788910518},
	{222507385,1826907586,92182554,625525411}, {139067116,336510873,594485008,927824294},
	{173833895,420638591,1279977172,1159780368}, {217292368,2136410975,1063100553,1449725460},
	{135807730,1335256859,1469744214,100772044}, {169759663,595329250,1300309355,1199706879},
	{212199579,207290651,551644870,962762687}, {265249473,1869726050,152685176,129711535},
	{165780921,363272413,632299147,81069709}, {207226151,990961428,1327244845,1711949873}
};
static int32_t const POW5_INV_SPLIT[291][4] =
{
	{536870912,0,0,0}, {429496729,0,0,0}, {343597383,0,0,0}, {274877906,0,0,0}, {439804651,0,0,0},
	{351843720,0,0,0}, {281474976,0,0,0}, {450359962,0,0,0}, {360287970,0,0,0}, {288230376,0,0,0},
	{461168601,0,0,0}, {368934881,0,0,0}, {295147905,0,0,0}, {472236648,0,0,0}, {377789318,0,0,0},
	{302231454,0,0,0}, {483570327,0,0,0}, {386856262,0,0,0}, {309485009,0,0,0}, {495176015,0,0,0},
	{396140812,0,0,0}, {316912650,0,0,0}, {507060240,0,0,0}, {405648192,0,0,0}, {324518553,0,0,0},
	{519229685,0,0,0}, {415383748,0,0,0}, {332306998,0,0,0}, {531691198,0,0,0}, {425352958,0,0,0},
	{340282366,0,0,0}, {272225893,0,0,0}, {435561429,0,0,0}, {348449143,0,0,0}, {278759314,0,0,0},
	{446014903,0,0,0}, {356811923,0,0,0}, {285449538,0,0,0}, {456719261,0,0,0}, {365375409,0,0,0},
	{292300327,0,0,0}, {467680523,0,0,0}, {374144419,0,0,0}, {299315535,0,0,0}, {478904856,0,0,0},
	{383123885,0,0,0}, {306499108,0,0,0}, {490398573,0,0,0}, {392318858,0,0,0}, {313855086,0,0,0},
	{502168138,0,0,0}, {401734511,0,0,0}, {321387608,0,0,0}, {514220174,0,0,0}, {411376139,0,0,0},
	{329100911,0,0,0}, {526561458,0,0,0}, {421249166,0,0,0}, {336999333,0,0,0}, {269599466,0,0,0},
	{431359146,0,0,0}, {345087317,0,0,0}, {276069853,0,0,0}, {441711766,0,0,0}, {353369412,0,0,0},
	{282695530,0,0,0}, {452312848,0,0,0}, {361850278,0,0,0}, {289480223,0,0,0}, {463168356,0,0,0},
	{370534685,0,0,0}, {296427748,0,0,0}, {474284397,0,0,0}, {379427518,0,0,0}, {303542014,0,0,0},
	{485667223,0,0,0}, {388533778,0,0,0}, {310827022,0,0,0}, {497323236,0,0,0}, {397858589,0,0,0},
	{318286871,0,0,0}, {509258994,0,0,0}, {407407195,0,0,0}, {325925756,0,0,0}, {521481209,0,0,0},
	{417184967,0,0,0}, {333747974,0,0,0}, {533996758,0,0,0}, {427197407,0,0,0}, {341757925,0,0,0},
	{273406340,0,0,0}, {437450144,0,0,0}, {349960115,0,0,0}, {279968092,0,0,0}, {447948948,0,0,0},
	{358359158,0,0,0}, {286687326,0,0,0}, {458699723,0,0,0}, {366959778,0,0,0}, {293567822,0,0,0},
	{469708516,0,0,0}, {375766813,0,0,0}, {300613450,0,0,0}, {480981520,0,0,0}, {384785216,0,0,0},
	{307828173,0,0,0}, {492525077,0,0,0}, {394020061,0,0,0}, {315216049,0,0,0}, {504345679,0,0,0},
	{403476543,0,0,0}, {322781234,0,0,0}, {516449975,0,0,0}, {413159980,0,0,0}, {330527984,0,0,0},
	{528844775,0,0,0}, {423075820,0,0,0}, {338460656,0,0,0}, {270768524,0,0,0}, {433229639,0,0,0},
	{346583711,0,0,0}, {277266969,0,0,0}, {443627151,0,0,0}, {354901720,0,0,0}, {283921376,0,0,0},
	{454274202,0,0,0}, {363419362,0,0,0}, {290735489,0,0,0}, {465176783,0,0,0}, {372141426,0,0,0},
	{297713141,0,0,0}, {476341026,0,0,0}, {381072821,0,0,0}, {304858256,0,0,0}, {487773210,0,0,0},
	{390218568,0,0,0}, {312174855,0,0,0}, {499479768,0,0,0}, {399583814,0,0,0}, {319667051,0,0,0},
	{511467282,0,0,0}, {409173825,0,0,0}, {327339060,0,0,0}, {523742497,0,0,0}, {418993997,0,0,0},
	{335195198,0,0,0}, {536312317,0,0,0}, {429049853,0,0,0}, {343239883,0,0,0}, {274591906,0,0,0},
	{439347050,0,0,0}, {351477640,0,0,0}, {281182112,0,0,0}, {449891379,0,0,0}, {359913103,0,0,0},
	{287930482,0,0,0}, {460688772,0,0,0}, {368551018,0,0,0}, {294840814,0,0,0}, {471745303,0,0,0},
	{377396242,0,0,0}, {301916993,0,0,0}, {483067190,0,0,0}, {386453752,0,0,0}, {309163001,0,0,0},
	{494660802,0,0,0}, {395728642,0,0,0}, {316582913,0,0,0}, {506532662,0,0,0}, {405226129,0,0,0},
	{324180903,0,0,0}, {518689446,0,0,0}, {414951556,0,0,0}, {331961245,0,0,0}, {531137992,0,0,0},
	{424910394,0,0,0}, {339928315,0,0,0}, {271942652,0,0,0}, {435108243,0,0,0}, {348086594,0,0,0},
	{278469275,0,0,0}, {445550841,0,0,0}, {356440673,0,0,0}, {285152538,0,0,0}, {456244061,0,0,0},
	{364995249,0,0,0}, {291996199,0,0,0}, {467193919,0,0,0}, {373755135,0,0,0}, {299004108,0,0,0},
	{478406573,0,0,0}, {382725258,0,0,0}, {306180206,0,0,0}, {489888331,0,0,0}, {391910664,0,0,0},
	{313528531,0,0,0}, {501645651,0,0,0}, {401316520,0,0,0}, {321053216,0,0,0}, {513685146,0,0,0},
	{410948117,0,0,0}, {328758493,0,0,0}, {526013590,0,0,0}, {420810872,0,0,0}, {336648697,0,0,0},
	{269318958,0,0,0}, {430910333,0,0,0}, {344728266,0,0,0}, {275782613,0,0,0}, {441252181,0,0,0},
	{353001744,0,0,0}, {282401395,0,0,0}, {451842233,0,0,0}, {361473786,0,0,0}, {289179029,0,0,0},
	{462686446,0,0,0}, {370149157,0,0,0}, {296119326,0,0,0}, {473790921,0,0,0}, {379032737,0,0,0},
	{303226189,0,0,0}, {485161903,0,0,0}, {388129523,0,0,0}, {310503618,0,0,0}, {496805789,0,0,0},
	{397444631,0,0,0}, {317955705,0,0,0}, {508729128,0,0,0}, {406983302,0,0,0}, {325586642,0,0,0},
	{520938627,0,0,0}, {416750902,0,0,0}, {333400721,0,0,0}, {533441154,0,0,0}, {426752923,0,0,0},
	{341402338,0,0,0}, {273121871,0,0,0}, {436994993,0,0,0}, {349595995,0,0,0}, {279676796,0,0,0},
	{447482873,0,0,0}, {357986298,0,0,0}, {286389039,0,0,0}, {458222462,0,0,0}, {366577970,0,0,0},
	{293262376,0,0,0}, {469219801,0,0,0}, {375375841,0,0,0}, {300300673,0,0,0}, {480481077,0,0,0},
	{384384861,0,0,0}, {307507889,0,0,0}, {492012622,0,0,0}, {393610098,0,0,0}, {314888078,0,0,0},
	{503820925,0,0,0}, {403056740,0,0,0}, {322445392,0,0,0}, {515912628,0,0,0}, {412730102,0,0,0},
	{330184081,0,0,0}, {528294531,0,0,0}, {422635624,0,0,0}, {338108499,0,0,0}, {270486799,0,0,0},
	{432778879,0,0,0}, {346223103,0,0,0}, {276978483,0,0,0}, {443165573,0,0,0}, {354532458,0,0,0},
	{283625966,0,0,0}, {453801546,0,0,0}, {363041237,0,0,0}, {290432989,0,0,0}, {464692783,0,0,0},
	{371754227,0,0,0}, {297403381,0,0,0}, {475845410,0,0,0}, {380676328,0,0,0}, {304541062,0,0,0},
	{487265700,0,0,0}, {389812560,0,0,0}, {311850048,0,0,0}, {498960077,0,0,0}, {399168061,0,0,0},
	{319334449,0,0,0}, {510935119,0,0,0}, {408748095,0,0,0}, {326998476,0,0,0}, {523197562,0,0,0},
	{418558049,0,0,0}
};



MOSS_ND_INLINE static int64_t _sar( int64_t val, int shift )
{
	union { int64_t i64; uint64_t u64; } u;
	u.i64 = val;
	u.u64 >>= shift;
	return u.i64;
}

/*
Given exponent p:=`exp`, returns ⌈log₂(5ᵖ)⌉, the number of bits required to represent 5ᵖ (by doing
⌊log₂(5ᵖ)⌋ + 1, ish).
*/
MOSS_ND_INLINE static int _exp5_nbits( int exp )
{
	return (int)_sar( exp*1217359, 19 ) + 1;
}

MOSS_ND_INLINE static int _num_digits( int64_t v )
{
	/* TODO: optimize */
	if      ( v >= 1000000000000000000LL ) return 19;
	else if ( v >=  100000000000000000LL ) return 18;
	else if ( v >=   10000000000000000LL ) return 17;
	else if ( v >=    1000000000000000LL ) return 16;
	else if ( v >=     100000000000000LL ) return 15;
	else if ( v >=      10000000000000LL ) return 14;
	else if ( v >=       1000000000000LL ) return 13;
	else if ( v >=        100000000000LL ) return 12;
	else if ( v >=         10000000000LL ) return 11;
	else if ( v >=          1000000000LL ) return 10;
	else if ( v >=           100000000LL ) return  9;
	else if ( v >=            10000000LL ) return  8;
	else if ( v >=             1000000LL ) return  7;
	else if ( v >=              100000LL ) return  6;
	else if ( v >=               10000LL ) return  5;
	else if ( v >=                1000LL ) return  4;
	else if ( v >=                 100LL ) return  3;
	else if ( v >=                  10LL ) return  2;
	else                                   return  1;
}

MOSS_ND_INLINE static int _pow5_factors( int64_t value )
{
	int count = 0;
	LOOP:
		if ( value%5 == 0 )
		{
			value /= 5;
			++count;
			goto LOOP;
		}
	return count;
}

MOSS_ND static int _is_mult_of_pow_of_5( int64_t value, int q )
{
	return _pow5_factors( value ) >= q;
}

/*
Compute the high digits of:

	m 5^p / 10^q   =   m 5^(p-q) / 2^q   =   m 5^i / 2^j

with "q" chosen so that "m 5^i / 2^j" has sufficiently many decimal digits to represent the original
floating-point number.
*/
MOSS_ND static int64_t _mul_pow5_div_pow2( int64_t m, int i, int j )
{
	// `m` has at most 55 bits.
	int64_t m_hi = _sar( m, 31 );
	int64_t m_lo = m & 0x7fffffff;

	int64_t bits13 = m_hi * POW5_SPLIT[i][0]; // 124
	int64_t bits03 = m_lo * POW5_SPLIT[i][0]; //  93
	int64_t bits12 = m_hi * POW5_SPLIT[i][1]; //  93
	int64_t bits02 = m_lo * POW5_SPLIT[i][1]; //  62
	int64_t bits11 = m_hi * POW5_SPLIT[i][2]; //  62
	int64_t bits01 = m_lo * POW5_SPLIT[i][2]; //  31
	int64_t bits10 = m_hi * POW5_SPLIT[i][3]; //  31
	int64_t bits00 = m_lo * POW5_SPLIT[i][3]; //   0

	int actual_shift = j - 3*31 - 21;
	assert( actual_shift >= 0 );
	return _sar(
		_sar(
			_sar(
				_sar(
					_sar(
						bits00,
						31
					) + bits01 + bits10,
					31
				) + bits02 + bits11,
				31
			) + bits03 + bits12,
			21
		) + (bits13<<10),
		actual_shift
	);
}

/*
Compute the high digits of "m / 5^i / 2^j" so that the result is accurate to at least 9 decimal
digits.  "i" and "j" are already chosen appropriately.
*/
MOSS_ND static int64_t _mul_pow5inv_div_pow2( int64_t m, int i, int j )
{
	// `m` has at most 55 bits.
	int64_t m_hi = _sar( m, 31 );
	int64_t m_lo = m & 0x7fffffff;

	int64_t bits13 = m_hi * POW5_INV_SPLIT[i][0];
	int64_t bits03 = m_lo * POW5_INV_SPLIT[i][0];
	int64_t bits12 = m_hi * POW5_INV_SPLIT[i][1];
	int64_t bits02 = m_lo * POW5_INV_SPLIT[i][1];
	int64_t bits11 = m_hi * POW5_INV_SPLIT[i][2];
	int64_t bits01 = m_lo * POW5_INV_SPLIT[i][2];
	int64_t bits10 = m_hi * POW5_INV_SPLIT[i][3];
	int64_t bits00 = m_lo * POW5_INV_SPLIT[i][3];

	int actual_shift = j - 3*31 - 21;
	assert( actual_shift >= 0 );
	return _sar(
		_sar(
			_sar(
				_sar(
					_sar(
						bits00,
						31
					) + bits01 + bits10,
					31
				) + bits02 + bits11,
				31
			) + bits03 + bits12,
			21
		) + (bits13<<10),
		actual_shift
	);
}

#if 1 /* "Conservative" rounding mode */
MOSS_ND_INLINE static int _accept_bound_lower( int /*even*/ ) { return 0   ; }
MOSS_ND_INLINE static int _accept_bound_upper( int /*even*/ ) { return 0   ; }
#else /* Round-even rounding mode */
MOSS_ND_INLINE static int _accept_bound_lower( int   even   ) { return even; }
MOSS_ND_INLINE static int _accept_bound_upper( int   even   ) { return even; }
#endif

void __moss_ftoa( char zeroed_buffer[309+1], double val, char specifier,int prec );
void __moss_ftoa( char zeroed_buffer[309+1], double val, char specifier,int prec )
{
	char* buf = zeroed_buffer;

	/*
	================================================================================================
	Step 1: Decode floating-point number, handle trivial cases, and setup
	================================================================================================
	*/
	#if 1

	__MOSS_Flt64 bits;
	bits.as_f64 = val;

	if ( bits.sign ) *(buf++)='-';

	if ( isnan(val) )
	{
		sprintf( buf, "nan" );
		return;
	}
	if ( isinf(val) )
	{
		sprintf( buf, "inf" );
		return;
	}
	if ( bits.absval_as_u64 == 0 )
	{
		if ( specifier=='f' || specifier=='F' )
		{
			sprintf( buf, "0.0" );
		}
		else
		{
			char ch_exp;
			switch ( specifier )
			{
				case 'e': ch_exp='e'; break;
				case 'E': ch_exp='E'; break;
				case 'g': ch_exp='e'; break;
				case 'G': ch_exp='E'; break;
				default:
					__moss_assert_false( "Invalid format specifier '%c'!", specifier );
			}
			if ( prec == -1 ) prec=6;
			sprintf( buf, "0.%.*d%c+00", prec,0, ch_exp );
		}

		return;
	}

	/* `val` must be a subnormal or normal by now; run full algorithm */

	int     e2 = bits.biasexp ;
	int64_t m2 = bits.mantissa;
	if ( bits.biasexp != 0 ) m2|=1LL<<52; /* normal; add implicit leading 1 to mantissa */
	else                     ++e2;        /* subnormal; biased exponent is actually 1 */
	e2 -= 1023 + 52; /* [-1074,971] */

	#endif

	/*
	================================================================================================
	Step 2: Determine the interval of legal decimal representations.
	================================================================================================
	*/
	#if 1

	int is_even = ( m2 & 1 ) == 0;
	int64_t mv = 4*m2;
	int64_t mp = 4*m2 + 2;
	int mm_shift = ( m2!=(1LL<<52) || bits.biasexp<=1 ) ? 1 : 0;
	int64_t mm = 4*m2 - 1 - mm_shift;
	e2 -= 2; /* [-1076,969] (in original implementation they wrongly think it's [-1077,968]) */

	#endif

	/*
	================================================================================================
	Step 3: Convert to a decimal power base using 128-bit arithmetic.
	================================================================================================
	*/
	#if 1

	static_assert( sizeof(int)>=4, "Invalid `int`!" );
	int64_t dv, dp, dm;
	int e10;
	int dm_is_trailing_zeros = 0;
	int dv_is_trailing_zeros = 0;
	if ( e2 >= 0 )
	{
		int q = ( e2*78913 >> 18 ) - 1;
		if ( q < 0 ) q=0;

		// k = constant + floor(log_2(5^q))
		int k = POW5_INV_NBITS + _exp5_nbits( q ) - 1;
		int i = -e2 + q + k;
		dv = _mul_pow5inv_div_pow2( mv, q, i );
		dp = _mul_pow5inv_div_pow2( mp, q, i );
		dm = _mul_pow5inv_div_pow2( mm, q, i );
		e10 = q;

		if ( q <= 21 )
		{
			if ( mv % 5 == 0 )
			{
				dv_is_trailing_zeros = _is_mult_of_pow_of_5( mv, q );
			}
			else if ( _accept_bound_upper( is_even ) )
			{
				dm_is_trailing_zeros = _is_mult_of_pow_of_5( mm, q );
			}
			else if ( _is_mult_of_pow_of_5( mp, q ) )
			{
				--dp;
			}
		}
	}
	else
	{
		int q = ( -e2*732923 >> 20 ) - 1;
		if ( q < 0 ) q=0;

		int i = -e2 - q;
		int k = _exp5_nbits( i ) - POW5_NBITS;
		int j = q - k;
		dv = _mul_pow5_div_pow2( mv, i, j );
		dp = _mul_pow5_div_pow2( mp, i, j );
		dm = _mul_pow5_div_pow2( mm, i, j );
		e10 = q + e2;

		if ( q <= 1 )
		{
			dv_is_trailing_zeros = 1;
			if ( _accept_bound_upper( is_even ) )
			{
				dm_is_trailing_zeros = mm_shift == 1;
			}
			else
			{
				--dp;
			}
		}
		else if ( q < 63 )
		{
			dv_is_trailing_zeros = ( mv & ((1LL<<(q-1))-1) ) == 0;
		}
	}

	#endif

	/*
	================================================================================================
	Step 4: Find the shortest decimal representation in the interval of legal representations.

	We do some extra work here in order to follow Float/Double.toString semantics. In particular,
	that requires printing in scientific format if and only if the exponent is between -3 and 7,
	and it requires printing at least two decimal digits.

	Above, we moved the decimal dot all the way to the right, so now we need to count digits to
	figure out the correct exponent for scientific notation.
	================================================================================================
	*/
	#if 1

	int vplength = _num_digits( dp );
	int exp = e10 + vplength - 1;

	int output_sci_form;
	if      ( specifier=='f' || specifier=='F' ) output_sci_form=0;
	else if ( specifier=='e' || specifier=='E' ) output_sci_form=1;
	else
	{
		assert( specifier=='g' || specifier=='G' );

		int P;
		if      ( prec == -1 ) P=6   ;
		else if ( prec ==  0 ) P=1   ;
		else                   P=prec;

		int X = bits.biasexp - 1023;
		prec = P - 1;
		if ( P>X && X>=-4 )
		{
			prec -= X;
			output_sci_form = 0;
			--specifier; /* "f", "F" */
		}
		else
		{
			output_sci_form = 1;
			specifier -= 2; /* "e", "E" */
		}
	}

	int removed = 0;

	int last_removed_digit = 0;
	int64_t output;
	if ( dm_is_trailing_zeros || dv_is_trailing_zeros )
	{
		while ( dp/10 > dm/10 )
		{
			if ( dp<100 && output_sci_form )
			{
				// Double.toString semantics requires printing at least two digits.
				break;
			}
			dm_is_trailing_zeros &= dm%10 == 0;
			dv_is_trailing_zeros &= last_removed_digit == 0;
			last_removed_digit = (int)( dv % 10 );
			dp /= 10;
			dv /= 10;
			dm /= 10;
			++removed;
		}
		if ( dm_is_trailing_zeros && _accept_bound_lower(is_even) )
		{
			while ( dm%10 == 0 )
			{
				if ( dp<100 && output_sci_form )
				{
					// Double.toString semantics requires printing at least two digits.
					break;
				}
				dv_is_trailing_zeros &= last_removed_digit == 0;
				last_removed_digit = (int)( dv % 10 );
				dp /= 10;
				dv /= 10;
				dm /= 10;
				++removed;
			}
		}
		if ( dv_is_trailing_zeros && last_removed_digit==5 && dv%2==0 )
		{
			// Round even if the exact numbers is .....50..0.
			last_removed_digit = 4;
		}
		output = dv + (
			last_removed_digit>=5 || (
				dv==dm &&
				!( dm_is_trailing_zeros && _accept_bound_lower(is_even) )
			)
			? 1 : 0
		);
	}
	else
	{
		while ( dp/10 > dm/10 )
		{
			if ( dp<100 && output_sci_form )
			{
				// Double.toString semantics requires printing at least two digits.
				break;
			}
			last_removed_digit = (int)( dv % 10 );
			dp /= 10;
			dv /= 10;
			dm /= 10;
			++removed;
		}
		output = dv + ( (dv==dm||last_removed_digit>=5) ? 1 : 0 );
	}
	int olength = vplength - removed;

	#endif

	/*
	================================================================================================
	Step 5: Print the decimal representation.
	================================================================================================
	*/
	#if 1

	if ( output_sci_form )
	{
		assert( specifier=='e' || specifier=='E' );

		/* Write significand, backward. */
		for ( int i=0; i<olength-1; ++i )
		{
			buf[ olength - i ] = (char)( '0' + output%10 );
			output /= 10;
		}
		buf[1] = '.';
		buf[0] = (char)( '0' + output%10 );

		buf += olength + 1;
		if ( olength == 1 )
		{
			*(buf++) = '0';
		}

		/* "e" or "E" */
		*(buf++) = specifier;

		/* "-" or "+" */
		if ( exp >= 0 ) { *(buf++)='+';           }
		else            { *(buf++)='-'; exp=-exp; }

		/* Exponent.  Note required to output at least two digits. */
		if ( exp >= 100 )
		{
			*(buf++) = (char)( '0' + exp/100 );
			exp %= 100;
		}
		*(buf++) = (char)( '0' + exp/10 );
		exp %= 10;
		*(buf++) = (char)( '0' + exp    );
	}
	else
	{
		assert( specifier=='f' || specifier=='F' );

		if ( exp < 0 ) /* Decimal dot is before any of the digits. */
		{
			*(buf++) = '0';
			*(buf++) = '.';

			for ( int i=-1; i>exp; --i )
			{
				*(buf++) = '0';
			}

			for ( int i=0; i<olength; ++i )
			{
				buf[ olength - i - 1 ] = (char)( '0' + output%10 );
				output /= 10;
			}
		}
		else if ( exp+1 >= olength ) /* Decimal dot is after any of the digits. */
		{
			for ( int i=0; i<olength; ++i )
			{
				buf[ olength - i - 1 ] = (char)( '0' + output%10 );
				output /= 10;
			}
			buf += olength;

			for ( int i=olength; i<exp+1; ++i )
			{
				*(buf++) = '0';
			}

			*(buf++) = '.';
			if ( prec == -1 ) *(buf++)='0';
			else
			{
				for ( int i=0; i<prec; ++i ) *(buf++)='0';
			}
		}
		else /* Decimal dot is somewhere between the digits. */
		{
			++buf;
			for ( int i=0; i<olength; ++i )
			{
				if ( olength-i-1 == exp )
				{
					buf[ olength - i - 1 ] = '.';
					--buf;
					break;
				}

				buf[ olength - i - 1 ] = (char)( '0' + output%10 );
				output /= 10;
			}
		}
	}

	#endif
}
